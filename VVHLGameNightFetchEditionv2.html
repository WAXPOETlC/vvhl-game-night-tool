<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VVHL Game Night</title>
    <style>
        :root {
            --page-bg: #2c3e50;
            --container-bg: #34495e;
            --text-color: #ecf0f1;
            --border-color: #7f8c8d;
            --accent-color: #3498db;
            --card-header-bg: #4a6278;
            --error-color: #e74c3c;
            --success-color: #2ecc71;
            --placeholder-color: #bdc3c7;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--page-bg);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            font-size: 14px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background-color: var(--container-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }

        .main-title-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 15px;
        }

        .league-logo {
            height: 50px;
            width: 50px;
            margin-right: 15px;
        }

        .main-title {
            font-size: 2.5em;
            font-weight: bold;
            text-align: center;
            background: linear-gradient(135deg, #f39c12, #e74c3c, #9b59b6, #3498db);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            -webkit-text-stroke: 0.5px #ffffffaa;
            padding: 5px 0;
        }

        .main-tabs-nav { display: flex; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        .main-tab-button { padding: 10px 20px; cursor: pointer; border: none; background-color: transparent; color: var(--text-color); font-size: 1.1em; border-bottom: 3px solid transparent; transition: all 0.3s ease; }
        .main-tab-button.active, .main-tab-button:hover { border-bottom-color: var(--accent-color); color: var(--accent-color); }
        .main-tab-content { display: none; }
        .main-tab-content.active { display: block; }

        .team-cards-grid { display: grid; gap: 20px; }
        .team-cards-grid.two-teams { grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); }
        
        .quad-game-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .game-pair { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; border: 1px solid var(--border-color); padding: 10px; border-radius: 5px; }
        .game-pair-title { grid-column: 1 / -1; text-align: center; font-weight: bold; margin-bottom: 10px; font-size: 1.1em; }

        .team-card { background-color: #2c3e50; border: 1px solid var(--border-color); border-radius: 6px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: flex; flex-direction: column; gap: 10px; }
        .team-card-header { display: flex; align-items: center; padding-bottom: 10px; margin-bottom: 10px; border-bottom: 2px solid var(--border-color); background-color: var(--card-header-bg); padding: 10px; border-radius: 4px 4px 0 0; min-height: 60px; }
        .team-logo { width: 40px; height: 40px; margin-right: 10px; object-fit: contain; background-color: #fff; border-radius: 4px; }
        .team-name-display { font-size: 1.3em; font-weight: bold; flex-grow: 1; }
        .team-management { font-size: 0.8em; text-align: right; }
        .team-management span { display: block; }

        select, button { padding: 8px 10px; background-color: #556a7e; color: var(--text-color); border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.95em; }
        select:focus, button:focus { outline: none; border-color: var(--accent-color); }
        button { cursor: pointer; }
        button:hover { background-color: #60788f; }

        .player-selectors { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        .player-selectors label { display: flex; flex-direction: column; gap: 5px; }

        .sub-tabs-nav { display: flex; margin-top: 25px; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .sub-tab-button { padding: 8px 15px; font-size: 1em; /* Inherits from .main-tab-button styles effectively */ }
        .sub-tab-content { display: none; padding: 15px; border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 4px 4px; background-color: #2c3e50; }
        .sub-tab-content.active { display: block; }
        
        .focus-game-buttons { margin-bottom: 15px; display: flex; gap: 10px; justify-content: center; }
        .focus-game-buttons button.active { background-color: var(--accent-color); color: white; }

        .player-stats-section, .recent-games-section { margin-top: 15px; padding-top: 15px; border-top: 1px dashed var(--border-color); }
        .player-stats-section h4, .recent-games-section h4 { margin-top: 0; }
        .recent-games-section ul { list-style-type: disc; padding-left: 20px; }
        .recent-games-section li { margin-bottom: 5px; }


        .player-filter-select { width: 100%; min-height: 80px; margin-bottom: 10px; }
        .player-stats-display-area div { margin-bottom: 8px; padding: 5px; background-color: #34495e; border-radius: 3px; }
        .player-stats-display-area strong { color: var(--accent-color); }
        .stats-placeholder { color: var(--placeholder-color); font-style: italic; }
        
        .comparison-grid { display: grid; grid-template-columns: 1fr auto 1fr; gap: 5px 15px; align-items: center; font-size: 0.9em;}
        .comparison-grid .stat-label { text-align: center; font-weight: bold; grid-column: 2 / 3; }
        .comparison-grid .player-name-header { font-weight: bold; text-align: center; margin-bottom: 5px;}
        .comparison-grid .player1-col { grid-column: 1 / 2; text-align: right;}
        .comparison-grid .player2-col { grid-column: 3 / 4; text-align: left;}
        .comparison-grid > div { padding: 3px 0; }

        .active-streams-section { margin-top: 30px; padding: 15px; background-color: #2c3e50; border-radius: 6px; border: 1px solid var(--border-color); }
        .active-streams-section h3 { margin-top: 0; }
        .active-streams-section ul { list-style-type: none; padding: 0; }
        .active-streams-section li a { color: var(--accent-color); text-decoration: none; }
        .active-streams-section li a:hover { text-decoration: underline; }

        .data-status { padding: 10px; margin-bottom: 5px; border-radius: 4px; text-align: center; font-size: 0.9em; }
        #dataFetchStatusContainer { margin-bottom: 15px;}
        .data-status.error { background-color: var(--error-color); color: white; }
        .data-status.loading { background-color: #f39c12; color: white; }
        .data-status.success { background-color: var(--success-color); color: white; }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-title-container">
            <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSIxMCIgZmlsbD0iZ3JheSIvPjxwYXRoIGZpbGw9IndoaXRlIiBkPSJNOS41IDE1LjVMMTMuNSA5LjUgTDE1IDEzWiIgLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1zaXplPSI2IiBmaWxsPSJibGFjayI+VlZITDwvdGV4dD48L3N2Zz4=" alt="League Logo" class="league-logo" id="leagueLogo">
            <h1 class="main-title">VVHL Game Night</h1>
        </div>

        <div id="dataFetchStatusContainer">
            <div id="playerDataStatus" class="data-status" style="display: none;"></div>
            <div id="goalieDataStatus" class="data-status" style="display: none;"></div>
            <div id="teamDataStatus" class="data-status" style="display: none;"></div>
            <div id="gameDataStatus" class="data-status" style="display: none;"></div>
            <div id="twitchDataStatus" class="data-status" style="display: none;"></div>
        </div>

        <nav class="main-tabs-nav">
            <button class="main-tab-button active" data-target="main-tab-915">9:15 PM</button>
            <button class="main-tab-button" data-target="main-tab-945">9:45 PM</button>
            <button class="main-tab-button" data-target="main-tab-quad">10:15 PM (Quad)</button>
        </nav>

        <!-- 9:15 PM Tab Content -->
        <div id="main-tab-915" class="main-tab-content active">
            <div class="team-cards-grid two-teams">
                <div class="team-card" id="tc-915-1">
                    <div class="team-card-header">
                        <img src="" alt="Team Logo" class="team-logo">
                        <span class="team-name-display">Home Team</span>
                        <div class="team-management"><span>O: <span class="owner-name">N/A</span></span><span>GM: <span class="gm-name">N/A</span></span></div>
                    </div>
                    <select class="team-select" data-team-card-id="tc-915-1" data-team-role="team1"><option value="">-- Select Team --</option></select>
                    <div class="player-selectors">
                        <label>C: <select class="player-select" data-position="C"><option value="">--</option></select></label>
                        <label>W: <select class="player-select" data-position="W"><option value="">--</option></select></label>
                        <label>D: <select class="player-select" data-position="D"><option value="">--</option></select></label>
                        <label>G: <select class="player-select" data-position="G"><option value="">--</option></select></label>
                    </div>
                </div>
                <div class="team-card" id="tc-915-2">
                     <div class="team-card-header">
                        <img src="" alt="Team Logo" class="team-logo">
                        <span class="team-name-display">Away Team</span>
                        <div class="team-management"><span>O: <span class="owner-name">N/A</span></span><span>GM: <span class="gm-name">N/A</span></span></div>
                    </div>
                    <select class="team-select" data-team-card-id="tc-915-2" data-team-role="team2"><option value="">-- Select Team --</option></select>
                    <div class="player-selectors">
                        <label>C: <select class="player-select" data-position="C"><option value="">--</option></select></label>
                        <label>W: <select class="player-select" data-position="W"><option value="">--</option></select></label>
                        <label>D: <select class="player-select" data-position="D"><option value="">--</option></select></label>
                        <label>G: <select class="player-select" data-position="G"><option value="">--</option></select></label>
                    </div>
                </div>
            </div>
            <div class="sub-tabs-section" id="subtabs-915">
                <nav class="sub-tabs-nav">
                    <button class="sub-tab-button active" data-target="subtab-915-matchup">Matchup</button>
                    <button class="sub-tab-button" data-target="subtab-915-team1-stats" id="subtab-btn-915-team1">[Home] Stats</button>
                    <button class="sub-tab-button" data-target="subtab-915-team2-stats" id="subtab-btn-915-team2">[Away] Stats</button>
                </nav>
                <div id="subtab-915-matchup" class="sub-tab-content active">
                    <h3>Team Comparison</h3>
                    <div id="team-comparison-915"><p class="stats-placeholder">Select two teams to see H2H comparison.</p></div>
                    <h3>Selected Player Comparison</h3>
                    <div id="player-comparison-915"><p class="stats-placeholder">Select players in both team cards to compare.</p></div>
                </div>
                <div id="subtab-915-team1-stats" class="sub-tab-content">
                    <h3>Team Season Stats</h3>
                    <div id="team-season-stats-915-team1"><p class="stats-placeholder">Select a team to see season stats.</p></div>
                    <div class="recent-games-section">
                        <h4>Last 6 Games Played</h4>
                        <div id="recent-games-915-team1"><p class="stats-placeholder">Team's recent games will appear here.</p></div>
                    </div>
                    <div class="player-stats-section">
                        <h4>Player Stats</h4>
                        <select multiple class="player-filter-select" id="player-filter-915-team1"></select>
                        <div class="player-stats-display-area" id="player-stats-display-915-team1">
                            <p class="stats-placeholder">Select player(s) from the list above to see their stats.</p>
                        </div>
                    </div>
                </div>
                <div id="subtab-915-team2-stats" class="sub-tab-content">
                    <h3>Team Season Stats</h3>
                    <div id="team-season-stats-915-team2"><p class="stats-placeholder">Select a team to see season stats.</p></div>
                    <div class="recent-games-section">
                        <h4>Last 6 Games Played</h4>
                        <div id="recent-games-915-team2"><p class="stats-placeholder">Team's recent games will appear here.</p></div>
                    </div>
                     <div class="player-stats-section">
                        <h4>Player Stats</h4>
                        <select multiple class="player-filter-select" id="player-filter-915-team2"></select>
                        <div class="player-stats-display-area" id="player-stats-display-915-team2">
                             <p class="stats-placeholder">Select player(s) from the list above to see their stats.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 9:45 PM Tab Content -->
        <div id="main-tab-945" class="main-tab-content">
            <div class="team-cards-grid two-teams">
                <div class="team-card" id="tc-945-1">
                    <div class="team-card-header">
                        <img src="" alt="Team Logo" class="team-logo">
                        <span class="team-name-display">Home Team</span>
                        <div class="team-management"><span>O: <span class="owner-name">N/A</span></span><span>GM: <span class="gm-name">N/A</span></span></div>
                    </div>
                    <select class="team-select" data-team-card-id="tc-945-1" data-team-role="team1"><option value="">-- Select Team --</option></select>
                    <div class="player-selectors">
                        <label>C: <select class="player-select" data-position="C"><option value="">--</option></select></label>
                        <label>W: <select class="player-select" data-position="W"><option value="">--</option></select></label>
                        <label>D: <select class="player-select" data-position="D"><option value="">--</option></select></label>
                        <label>G: <select class="player-select" data-position="G"><option value="">--</option></select></label>
                    </div>
                </div>
                <div class="team-card" id="tc-945-2">
                     <div class="team-card-header">
                        <img src="" alt="Team Logo" class="team-logo">
                        <span class="team-name-display">Away Team</span>
                        <div class="team-management"><span>O: <span class="owner-name">N/A</span></span><span>GM: <span class="gm-name">N/A</span></span></div>
                    </div>
                    <select class="team-select" data-team-card-id="tc-945-2" data-team-role="team2"><option value="">-- Select Team --</option></select>
                    <div class="player-selectors">
                        <label>C: <select class="player-select" data-position="C"><option value="">--</option></select></label>
                        <label>W: <select class="player-select" data-position="W"><option value="">--</option></select></label>
                        <label>D: <select class="player-select" data-position="D"><option value="">--</option></select></label>
                        <label>G: <select class="player-select" data-position="G"><option value="">--</option></select></label>
                    </div>
                </div>
            </div>
            <div class="sub-tabs-section" id="subtabs-945">
                <nav class="sub-tabs-nav">
                    <button class="sub-tab-button active" data-target="subtab-945-matchup">Matchup</button>
                    <button class="sub-tab-button" data-target="subtab-945-team1-stats" id="subtab-btn-945-team1">[Home] Stats</button>
                    <button class="sub-tab-button" data-target="subtab-945-team2-stats" id="subtab-btn-945-team2">[Away] Stats</button>
                </nav>
                <div id="subtab-945-matchup" class="sub-tab-content active">
                    <h3>Team Comparison</h3>
                     <div id="team-comparison-945"><p class="stats-placeholder">Select two teams to see H2H comparison.</p></div>
                    <h3>Selected Player Comparison</h3>
                    <div id="player-comparison-945"><p class="stats-placeholder">Select players in both team cards to compare.</p></div>
                </div>
                <div id="subtab-945-team1-stats" class="sub-tab-content">
                    <h3>Team Season Stats</h3>
                    <div id="team-season-stats-945-team1"><p class="stats-placeholder">Select a team to see season stats.</p></div>
                    <div class="recent-games-section">
                        <h4>Last 6 Games Played</h4>
                        <div id="recent-games-945-team1"><p class="stats-placeholder">Team's recent games will appear here.</p></div>
                    </div>
                    <div class="player-stats-section">
                        <h4>Player Stats</h4>
                        <select multiple class="player-filter-select" id="player-filter-945-team1"></select>
                        <div class="player-stats-display-area" id="player-stats-display-945-team1">
                            <p class="stats-placeholder">Select player(s) from the list above to see their stats.</p>
                        </div>
                    </div>
                </div>
                <div id="subtab-945-team2-stats" class="sub-tab-content">
                    <h3>Team Season Stats</h3>
                     <div id="team-season-stats-945-team2"><p class="stats-placeholder">Select a team to see season stats.</p></div>
                    <div class="recent-games-section">
                        <h4>Last 6 Games Played</h4>
                        <div id="recent-games-945-team2"><p class="stats-placeholder">Team's recent games will appear here.</p></div>
                    </div>
                    <div class="player-stats-section">
                        <h4>Player Stats</h4>
                        <select multiple class="player-filter-select" id="player-filter-945-team2"></select>
                        <div class="player-stats-display-area" id="player-stats-display-945-team2">
                            <p class="stats-placeholder">Select player(s) from the list above to see their stats.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 10:15 PM (Quad) Tab Content -->
        <div id="main-tab-quad" class="main-tab-content">
            <div class="quad-game-row">
                <div class="game-pair" id="quad-gp1">
                    <h4 class="game-pair-title">Game 1</h4>
                    <div class="team-card" id="tc-quad-g1a">
                        <div class="team-card-header"><img src="" alt="Logo" class="team-logo"><span class="team-name-display">Team A</span><div class="team-management">O:<span class="owner-name">N/A</span> G:<span class="gm-name">N/A</span></div></div>
                        <select class="team-select" data-team-card-id="tc-quad-g1a" data-quad-game="1" data-quad-team-role="A"><option value="">--</option></select>
                        <div class="player-selectors">
                            <label>C: <select class="player-select" data-position="C"><option value="">--</option></select></label> <label>W: <select class="player-select" data-position="W"><option value="">--</option></select></label>
                            <label>D: <select class="player-select" data-position="D"><option value="">--</option></select></label> <label>G: <select class="player-select" data-position="G"><option value="">--</option></select></label>
                        </div>
                    </div>
                    <div class="team-card" id="tc-quad-g1b">
                        <div class="team-card-header"><img src="" alt="Logo" class="team-logo"><span class="team-name-display">Team B</span><div class="team-management">O:<span class="owner-name">N/A</span> G:<span class="gm-name">N/A</span></div></div>
                        <select class="team-select" data-team-card-id="tc-quad-g1b" data-quad-game="1" data-quad-team-role="B"><option value="">--</option></select>
                        <div class="player-selectors">
                            <label>C: <select class="player-select" data-position="C"><option value="">--</option></select></label> <label>W: <select class="player-select" data-position="W"><option value="">--</option></select></label>
                            <label>D: <select class="player-select" data-position="D"><option value="">--</option></select></label> <label>G: <select class="player-select" data-position="G"><option value="">--</option></select></label>
                        </div>
                    </div>
                </div>
                <div class="game-pair" id="quad-gp2">
                    <h4 class="game-pair-title">Game 2</h4>
                    <div class="team-card" id="tc-quad-g2a">
                         <div class="team-card-header"><img src="" alt="Logo" class="team-logo"><span class="team-name-display">Team C</span><div class="team-management">O:<span class="owner-name">N/A</span> G:<span class="gm-name">N/A</span></div></div>
                        <select class="team-select" data-team-card-id="tc-quad-g2a" data-quad-game="2" data-quad-team-role="A"><option value="">--</option></select>
                        <div class="player-selectors">
                            <label>C: <select class="player-select" data-position="C"><option value="">--</option></select></label> <label>W: <select class="player-select" data-position="W"><option value="">--</option></select></label>
                            <label>D: <select class="player-select" data-position="D"><option value="">--</option></select></label> <label>G: <select class="player-select" data-position="G"><option value="">--</option></select></label>
                        </div>
                    </div>
                    <div class="team-card" id="tc-quad-g2b">
                         <div class="team-card-header"><img src="" alt="Logo" class="team-logo"><span class="team-name-display">Team D</span><div class="team-management">O:<span class="owner-name">N/A</span> G:<span class="gm-name">N/A</span></div></div>
                        <select class="team-select" data-team-card-id="tc-quad-g2b" data-quad-game="2" data-quad-team-role="B"><option value="">--</option></select>
                        <div class="player-selectors">
                            <label>C: <select class="player-select" data-position="C"><option value="">--</option></select></label> <label>W: <select class="player-select" data-position="W"><option value="">--</option></select></label>
                            <label>D: <select class="player-select" data-position="D"><option value="">--</option></select></label> <label>G: <select class="player-select" data-position="G"><option value="">--</option></select></label>
                        </div>
                    </div>
                </div>
            </div>
             <div class="quad-game-row">
                <div class="game-pair" id="quad-gp3">
                    <h4 class="game-pair-title">Game 3</h4>
                    <div class="team-card" id="tc-quad-g3a">
                        <div class="team-card-header"><img src="" alt="Logo" class="team-logo"><span class="team-name-display">Team E</span><div class="team-management">O:<span class="owner-name">N/A</span> G:<span class="gm-name">N/A</span></div></div>
                        <select class="team-select" data-team-card-id="tc-quad-g3a" data-quad-game="3" data-quad-team-role="A"><option value="">--</option></select>
                        <div class="player-selectors">
                            <label>C: <select class="player-select" data-position="C"><option value="">--</option></select></label> <label>W: <select class="player-select" data-position="W"><option value="">--</option></select></label>
                            <label>D: <select class="player-select" data-position="D"><option value="">--</option></select></label> <label>G: <select class="player-select" data-position="G"><option value="">--</option></select></label>
                        </div>
                    </div>
                    <div class="team-card" id="tc-quad-g3b">
                        <div class="team-card-header"><img src="" alt="Logo" class="team-logo"><span class="team-name-display">Team F</span><div class="team-management">O:<span class="owner-name">N/A</span> G:<span class="gm-name">N/A</span></div></div>
                        <select class="team-select" data-team-card-id="tc-quad-g3b" data-quad-game="3" data-quad-team-role="B"><option value="">--</option></select>
                        <div class="player-selectors">
                            <label>C: <select class="player-select" data-position="C"><option value="">--</option></select></label> <label>W: <select class="player-select" data-position="W"><option value="">--</option></select></label>
                            <label>D: <select class="player-select" data-position="D"><option value="">--</option></select></label> <label>G: <select class="player-select" data-position="G"><option value="">--</option></select></label>
                        </div>
                    </div>
                </div>
                <div class="game-pair" id="quad-gp4">
                    <h4 class="game-pair-title">Game 4</h4>
                    <div class="team-card" id="tc-quad-g4a">
                        <div class="team-card-header"><img src="" alt="Logo" class="team-logo"><span class="team-name-display">Team G</span><div class="team-management">O:<span class="owner-name">N/A</span> G:<span class="gm-name">N/A</span></div></div>
                        <select class="team-select" data-team-card-id="tc-quad-g4a" data-quad-game="4" data-quad-team-role="A"><option value="">--</option></select>
                        <div class="player-selectors">
                            <label>C: <select class="player-select" data-position="C"><option value="">--</option></select></label> <label>W: <select class="player-select" data-position="W"><option value="">--</option></select></label>
                            <label>D: <select class="player-select" data-position="D"><option value="">--</option></select></label> <label>G: <select class="player-select" data-position="G"><option value="">--</option></select></label>
                        </div>
                    </div>
                    <div class="team-card" id="tc-quad-g4b">
                        <div class="team-card-header"><img src="" alt="Logo" class="team-logo"><span class="team-name-display">Team H</span><div class="team-management">O:<span class="owner-name">N/A</span> G:<span class="gm-name">N/A</span></div></div>
                        <select class="team-select" data-team-card-id="tc-quad-g4b" data-quad-game="4" data-quad-team-role="B"><option value="">--</option></select>
                        <div class="player-selectors">
                            <label>C: <select class="player-select" data-position="C"><option value="">--</option></select></label> <label>W: <select class="player-select" data-position="W"><option value="">--</option></select></label>
                            <label>D: <select class="player-select" data-position="D"><option value="">--</option></select></label> <label>G: <select class="player-select" data-position="G"><option value="">--</option></select></label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sub-tabs-section" id="subtabs-quad">
                <div class="focus-game-buttons" id="quad-focus-game-btns">
                    <button class="focus-game-button active" data-game-num="1">Focus Game 1</button>
                    <button class="focus-game-button" data-game-num="2">Focus Game 2</button>
                    <button class="focus-game-button" data-game-num="3">Focus Game 3</button>
                    <button class="focus-game-button" data-game-num="4">Focus Game 4</button>
                </div>
                <nav class="sub-tabs-nav">
                    <button class="sub-tab-button active" data-target="subtab-quad-matchup">Matchup</button>
                    <button class="sub-tab-button" data-target="subtab-quad-teamA-stats" id="subtab-btn-quad-teamA">[Focus A] Stats</button>
                    <button class="sub-tab-button" data-target="subtab-quad-teamB-stats" id="subtab-btn-quad-teamB">[Focus B] Stats</button>
                </nav>
                <div id="subtab-quad-matchup" class="sub-tab-content active">
                    <h3>Team Comparison (Focused Game)</h3>
                    <div id="team-comparison-quad"><p class="stats-placeholder">Select two teams in a focused game to see H2H comparison.</p></div>
                    <h3>Selected Player Comparison (Focused Game)</h3>
                    <div id="player-comparison-quad"><p class="stats-placeholder">Select players in focused game cards to compare.</p></div>
                </div>
                <div id="subtab-quad-teamA-stats" class="sub-tab-content">
                    <h3>Team Season Stats</h3>
                    <div id="team-season-stats-quad-teamA"><p class="stats-placeholder">Select a team to see season stats.</p></div>
                    <div class="recent-games-section">
                        <h4>Last 6 Games Played</h4>
                        <div id="recent-games-quad-teamA"><p class="stats-placeholder">Team's recent games will appear here.</p></div>
                    </div>
                    <div class="player-stats-section">
                        <h4>Player Stats</h4>
                        <select multiple class="player-filter-select" id="player-filter-quad-teamA"></select>
                        <div class="player-stats-display-area" id="player-stats-display-quad-teamA">
                            <p class="stats-placeholder">Select player(s) to see stats.</p>
                        </div>
                    </div>
                </div>
                 <div id="subtab-quad-teamB-stats" class="sub-tab-content">
                    <h3>Team Season Stats</h3>
                    <div id="team-season-stats-quad-teamB"><p class="stats-placeholder">Select a team to see season stats.</p></div>
                     <div class="recent-games-section">
                        <h4>Last 6 Games Played</h4>
                        <div id="recent-games-quad-teamB"><p class="stats-placeholder">Team's recent games will appear here.</p></div>
                    </div>
                    <div class="player-stats-section">
                        <h4>Player Stats</h4>
                        <select multiple class="player-filter-select" id="player-filter-quad-teamB"></select>
                        <div class="player-stats-display-area" id="player-stats-display-quad-teamB">
                            <p class="stats-placeholder">Select player(s) to see stats.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="active-streams-section">
            <h3>Active Player Streams</h3>
            <ul id="activeStreamsList"><li class="stats-placeholder">No players selected with Twitch streams.</li></ul>
        </div>
    </div>

<script>
    // --- STATIC DATA (Hardcoded) ---
    // IMPORTANT: Populate this with your 14 teams. Ensure 'id' is numerical and matches your stats sheets.
    const teamsData = [
    {
        id: "6330",
        name: "VVHL Angry Byrds",
        logoUrl: "https://raw.githubusercontent.com/WAXPOETlC/vvhl-game-night-tool/main/logos/angry_byrds.png", // EXAMPLE - REPLACE
        primaryColor: "#FF0000", // Example
        secondaryColor: "#000000", // Example
        owner: "jaybyrd04",
        gm: "InfiniteMadness3"
    },
    {
        id: "925",
        name: "VVHL Blue Dragons",
        logoUrl: "https://raw.githubusercontent.com/WAXPOETlC/vvhl-game-night-tool/main/logos/blue_dragons.png", // EXAMPLE - REPLACE
        primaryColor: "#0000FF", // Example
        secondaryColor: "#FFFFFF", // Example
        owner: "l Setty l",
        gm: "Carney l94l"
    },
    {
        id: "195791",
        name: "VVHL Bravehearts",
        logoUrl: "https://raw.githubusercontent.com/WAXPOETlC/vvhl-game-night-tool/main/logos/bravehearts.png", // EXAMPLE - REPLACE
        primaryColor: "#00008B", // Example
        secondaryColor: "#FFD700", // Example
        owner: "T8kEITEzZz",
        gm: "ItsJayno" // Assuming Jayno780 is ItsJayno
    },
    {
        id: "192189",
        name: "VVHL Degenerates",
        logoUrl: "https://raw.githubusercontent.com/WAXPOETlC/vvhl-game-night-tool/main/logos/degenerates.png", // EXAMPLE - REPLACE
        primaryColor: "#8B0000", // Example
        secondaryColor: "#D3D3D3", // Example
        owner: "MarkyMarccc",
        gm: "NotLuigi420"
    },
    {
        id: "122924",
        name: "VVHL Flying Dutchmen",
        logoUrl: "https://raw.githubusercontent.com/WAXPOETlC/vvhl-game-night-tool/main/logos/flying_dutchmen.png", // EXAMPLE - REPLACE
        primaryColor: "#FFA500", // Example
        secondaryColor: "#000080", // Example
        owner: "MineHeart--", // Reconciled name
        gm: "Stafano99"
    },
    {
        id: "177596",
        name: "VVHL Hangry Moose",
        logoUrl: "https://raw.githubusercontent.com/WAXPOETlC/vvhl-game-night-tool/main/logos/hangry_moose.png", // EXAMPLE - REPLACE
        primaryColor: "#A0522D", // Example
        secondaryColor: "#006400", // Example
        owner: "Squad86lemm",
        gm: "BigTRUCK20"
    },
    {
        id: "124443",
        name: "VVHL Himmytown Huskies",
        logoUrl: "https://raw.githubusercontent.com/WAXPOETlC/vvhl-game-night-tool/main/logos/himmytown_huskies.png", // EXAMPLE - REPLACE
        primaryColor: "#ADD8E6", // Example
        secondaryColor: "#808080", // Example
        owner: "Taylz7", // Reconciled name
        gm: "EKMetal"
    },
    {
        id: "192462",
        name: "VVHL Lost Boys",
        logoUrl: "https://raw.githubusercontent.com/WAXPOETlC/vvhl-game-night-tool/main/logos/lost_boys.png", // EXAMPLE - REPLACE
        primaryColor: "#008000", // Example
        secondaryColor: "#FFFF00", // Example
        owner: "SuPeRmArIoTa15",
        gm: "Theone-iso"
    },
    {
        id: "148983",
        name: "VVHL Philly Cheeseskates",
        logoUrl: "https://raw.githubusercontent.com/WAXPOETlC/vvhl-game-night-tool/main/logos/philly_cheeseskates.png", // EXAMPLE - REPLACE
        primaryColor: "#FFC0CB", // Example
        secondaryColor: "#FFA500", // Example
        owner: "SadAttorney",
        gm: "GwHitTs MF" // Reconciled name
    },
    {
        id: "109941",
        name: "VVHL Portage Moneyshots",
        logoUrl: "https://raw.githubusercontent.com/WAXPOETlC/vvhl-game-night-tool/main/logos/portage_moneyshots.png", // EXAMPLE - REPLACE
        primaryColor: "#800080", // Example
        secondaryColor: "#FFFF00", // Example
        owner: "Jessejen", // Reconciled name
        gm: "Shockedust"
    },
    {
        id: "195310",
        name: "VVHL Sewer Kings",
        logoUrl: "https://raw.githubusercontent.com/WAXPOETlC/vvhl-game-night-tool/main/logos/sewer_kings.png", // EXAMPLE - REPLACE
        primaryColor: "#808080", // Example
        secondaryColor: "#00FF00", // Example
        owner: "lXlBMac24lXl", // Reconciled name
        gm: "showstopr87"
    },
    {
        id: "2411",
        name: "VVHL Sicilian Slicers",
        logoUrl: "https://raw.githubusercontent.com/WAXPOETlC/vvhl-game-night-tool/main/logos/sicilian_slicers.png", // EXAMPLE - REPLACE
        primaryColor: "#DC143C", // Example
        secondaryColor: "#000000", // Example
        owner: "x3xhoagiex0x",
        gm: "Buckneison"
    },
    {
        id: "197685",
        name: "VVHL Southbeach Snipers",
        logoUrl: "https://raw.githubusercontent.com/WAXPOETlC/vvhl-game-night-tool/main/logos/southbeach_snipers.png", // EXAMPLE - REPLACE
        primaryColor: "#00FFFF", // Example
        secondaryColor: "#FF69B4", // Example
        owner: "oi Caustic",
        gm: "Biz l16l" // Reconciled name
    },
    {
        id: "24504",
        name: "VVHL Tampa Bay Tribe",
        logoUrl: "https://raw.githubusercontent.com/WAXPOETlC/vvhl-game-night-tool/main/logos/tampa_bay_tribe.png", // EXAMPLE - REPLACE
        primaryColor: "#FFD700", // Example
        secondaryColor: "#4B0082", // Example
        owner: "JG813", // Assuming JG is JG813
        gm: "MikeyPT4899" // Assuming MikeyPT is MikeyPT4899
    }
];

    // IMPORTANT: Populate this with ALL your players.
    // 'name' should match 'Username' from stats sheets. 'teamId' should be numerical.
    // 'role', 'draftRound', 'isECU', 'twitch' should be accurate.
    let staticPlayersData = [
        // VVHL Angry Byrds (ID: "6330")
        { name: "NihilisticYeti", playerId: "PLAYERID_NihilisticYeti", teamId: "6330", primaryPosition: "W", secondaryPosition: "D", goaliePreference: "part time", draftPick: 8, draftRound: 1, role: null, isECU: false, twitch: null },
        { name: "Mattattack4072", playerId: "PLAYERID_Mattattack4072", teamId: "6330", primaryPosition: "G", secondaryPosition: "C", goaliePreference: "full time", draftPick: 21, draftRound: 2, role: null, isECU: false, twitch: null },
        { name: "BulkyMicrobe", playerId: "PLAYERID_BulkyMicrobe", teamId: "6330", primaryPosition: "G", secondaryPosition: "C", goaliePreference: "full time", draftPick: 36, draftRound: 3, role: null, isECU: false, twitch: null },
        { name: "Gage0906", playerId: "PLAYERID_Gage0906", teamId: "6330", primaryPosition: "W", secondaryPosition: "C", goaliePreference: "no goalie", draftPick: 49, draftRound: 4, role: null, isECU: false, twitch: null },
        { name: "Phoenix1381", playerId: "PLAYERID_Phoenix1381", teamId: "6330", primaryPosition: "D", secondaryPosition: "W", goaliePreference: "part time", draftPick: 64, draftRound: 5, role: null, isECU: false, twitch: null },
        { name: "Itz_Nitro71-TTV", playerId: "PLAYERID_Itz_Nitro71-TTV", teamId: "6330", primaryPosition: "C", secondaryPosition: "W", goaliePreference: "no goalie", draftPick: 77, draftRound: 6, role: null, isECU: false, twitch: null },
        { name: "jaybyrd04", playerId: "PLAYERID_jaybyrd04", teamId: "6330", role: "Owner", primaryPosition: null, secondaryPosition: null, goaliePreference: "no goalie", draftPick: null, draftRound: null, isECU: false, twitch: null },
        { name: "InfiniteMadness3", playerId: "PLAYERID_InfiniteMadness3", teamId: "6330", role: "GM", primaryPosition: null, secondaryPosition: null, goaliePreference: "no goalie", draftPick: null, draftRound: null, isECU: false, twitch: null },

        // VVHL Blue Dragons (ID: "925")
        { name: "EzDunk", playerId: "PLAYERID_EzDunk", teamId: "925", primaryPosition: "G", secondaryPosition: "G", goaliePreference: "full time", draftPick: 2, draftRound: 1, role: null, isECU: false, twitch: null },
        { name: "Octodaddy94", playerId: "PLAYERID_Octodaddy94", teamId: "925", primaryPosition: "W", secondaryPosition: "D", goaliePreference: "no goalie", draftPick: 27, draftRound: 2, role: null, isECU: false, twitch: null },
        { name: "OviTheGr8_GOAT", playerId: "PLAYERID_OviTheGr8_GOAT", teamId: "925", primaryPosition: "W", secondaryPosition: "C", goaliePreference: "no goalie", draftPick: 42, draftRound: 3, role: null, isECU: false, twitch: null },
        { name: "WHYAMISORAW", playerId: "PLAYERID_WHYAMISORAW", teamId: "925", primaryPosition: "W", secondaryPosition: "C", goaliePreference: "no goalie", draftPick: 55, draftRound: 4, role: null, isECU: false, twitch: null },
        { name: "Kooksy L27L", playerId: "PLAYERID_Kooksy_L27L", teamId: "925", primaryPosition: "W", secondaryPosition: "C", goaliePreference: "no goalie", draftPick: 58, draftRound: 5, role: null, isECU: false, twitch: null },
        { name: "x53ct10n8x", playerId: "PLAYERID_x53ct10n8x", teamId: "925", primaryPosition: "W", secondaryPosition: "C", goaliePreference: "part time", draftPick: 70, draftRound: 5, role: null, isECU: false, twitch: null },
        { name: "l Setty l", playerId: "PLAYERID_l_Setty_l", teamId: "925", primaryPosition: "C", secondaryPosition: "W", goaliePreference: "no goalie", draftPick: null, draftRound: null, role: "Owner", isECU: false, twitch: null },
        { name: "Carney l94l", playerId: "PLAYERID_Carney_l94l", teamId: "925", primaryPosition: "D", secondaryPosition: null, goaliePreference: "no goalie", draftPick: null, draftRound: null, role: "GM", isECU: false, twitch: null },

        // VVHL Flying Dutchmen (ID: "122924")
        { name: "Vynnerganson13", playerId: "PLAYERID_Vynnerganson13", teamId: "122924", primaryPosition: "G", secondaryPosition: "W", goaliePreference: "full time", draftPick: 4, draftRound: 1, role: null, isECU: false, twitch: null },
        { name: "Dmb Dex225", playerId: "PLAYERID_Dmb_Dex225", teamId: "122924", primaryPosition: "W", secondaryPosition: "C", goaliePreference: "no goalie", draftPick: 25, draftRound: 2, role: null, isECU: false, twitch: null },
        { name: "Krehzii", playerId: "PLAYERID_Krehzii", teamId: "122924", primaryPosition: "W", secondaryPosition: "C", goaliePreference: "no goalie", draftPick: 32, draftRound: 3, role: null, isECU: false, twitch: null },
        { name: "BubbA-HasH-", playerId: "PLAYERID_BubbA-HasH-", teamId: "122924", primaryPosition: "W", secondaryPosition: "W", goaliePreference: "no goalie", draftPick: 53, draftRound: 4, role: null, isECU: false, twitch: null },
        { name: "xWiggetyx", playerId: "PLAYERID_xWiggetyx", teamId: "122924", primaryPosition: "D", secondaryPosition: "W", goaliePreference: "no goalie", draftPick: 60, draftRound: 5, role: null, isECU: false, twitch: null },
        { name: "PapaPalpatine79", playerId: "PLAYERID_PapaPalpatine79", teamId: "122924", primaryPosition: "W", secondaryPosition: "D", goaliePreference: "no goalie", draftPick: 81, draftRound: 6, role: null, isECU: false, twitch: null }, // Also an Owner in teamsData, confirm if this is his player entry
        { name: "MineHeart--", playerId: "PLAYERID_MineHeart--", teamId: "122924", primaryPosition: "D", secondaryPosition: null, goaliePreference: "no goalie", draftPick: null, draftRound: null, role: "Owner", isECU: false, twitch: null }, // Name reconciled
        { name: "Stafano99", playerId: "PLAYERID_Stafano99", teamId: "122924", role: "GM", primaryPosition: null, secondaryPosition: null, goaliePreference: "no goalie", draftPick: null, draftRound: null, isECU: false, twitch: null },

        // ... (CONTINUE THIS PATTERN FOR ALL 14 TEAMS AND ALL THEIR PLAYERS, INCLUDING OWNERS/GMS)
        // ... ENSURE PlayerIDs are unique if you know them, or use a placeholder like "PLAYERID_Gamertag" ensuring uniqueness
        // ... Correct player names to match your provided stats list
        // ... Assign 'role' to Owners/GMs, and if they also play, keep their playing positions
        // Example for a player who is also GM:
        // { name: "BigTRUCK20", playerId: "PLAYERID_BigTRUCK20", teamId: "177596", primaryPosition: "W", secondaryPosition: "C", goaliePreference: "no goalie", draftPick: (HisDraftPickIfAny), draftRound: (HisDraftRoundIfAny), role: "GM", isECU: false, twitch: null },
    ];

    // Function to calculate draft round
    function calculateDraftRound(draftPick, teamsPerRound = 14) {
        if (typeof draftPick !== 'number' || draftPick < 0) { // Allow pick 0
            return null;
        }
        if (draftPick === 0) return 1; // Special case for pick 0 if it implies first round
        return Math.ceil(draftPick / teamsPerRound);
    }

    // Update draft rounds for players who have a numerical draftPick
    staticPlayersData = staticPlayersData.map(player => {
        if (typeof player.draftPick === 'number') {
            player.draftRound = calculateDraftRound(player.draftPick);
        }
        return player;
    });


    // --- GOOGLE SHEET URLs (REPLACE WITH YOUR ACTUAL PUBLISHED CSV URLs) ---
    const URL_AGGREGATED_SKATER_STATS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSQoY1nXkn_a7YQGKCctu7EKUdllUBeJUVEIEhZ0o1nVDc2UsEOx8PjHIcecrFwFvMMmVJG1h14Uu_Q/pub?gid=426970088&single=true&output=csv";
    const URL_AGGREGATED_GOALIE_STATS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSQoY1nXkn_a7YQGKCctu7EKUdllUBeJUVEIEhZ0o1nVDc2UsEOx8PjHIcecrFwFvMMmVJG1h14Uu_Q/pub?gid=1307848908&single=true&output=csv";
    const URL_PUBLISHED_TEAM_STATS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSQoY1nXkn_a7YQGKCctu7EKUdllUBeJUVEIEhZ0o1nVDc2UsEOx8PjHIcecrFwFvMMmVJG1h14Uu_Q/pub?gid=199453050&single=true&output=csv";
    const URL_PUBLISHED_GAME_DATA = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSQoY1nXkn_a7YQGKCctu7EKUdllUBeJUVEIEhZ0o1nVDc2UsEOx8PjHIcecrFwFvMMmVJG1h14Uu_Q/pub?gid=806195268&single=true&output=csv";
    const URL_TWITCH_LINKS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vScIWKrnIs5B3fey-aAvYLd9BEseCniHN-fXcdgUaURwYzFKnN48bhumLPgCuOh52Yj8XUGSZzwq3TW/pub?gid=0&single=true&output=csv";

    // --- GLOBAL STATE FOR FETCHED DATA ---
    let skaterSeasonStats = {};   // Keyed by Username from sheet
    let goalieSeasonStats = {};   // Keyed by Username from sheet
    let teamSeasonStats = {};     // Keyed by Team ID (numerical)
    let allGamesData = [];        // Array of game objects
    let playerTwitchLinks = {}; // Keyed by Username

    // --- DATA FETCHING AND PARSING ---
    async function fetchAndParseCsv(csvUrl, statusElementId, dataName) {
        const statusEl = document.getElementById(statusElementId);
        statusEl.textContent = `Fetching ${dataName}...`;
        statusEl.className = 'data-status loading';
        statusEl.style.display = 'block';
        try {
            const response = await fetch(csvUrl);
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status} for ${dataName}`);
            const csvText = await response.text();
            statusEl.textContent = `${dataName} fetched. Parsing...`;
            const parsedData = parseCSV(csvText);
            statusEl.textContent = `${dataName} loaded and parsed successfully.`;
            statusEl.className = 'data-status success';
            return parsedData;
        } catch (error) {
            console.error(`Error fetching/parsing ${dataName}:`, error);
            statusEl.textContent = `Error loading ${dataName}: ${error.message}. Stats might be unavailable.`;
            statusEl.className = 'data-status error';
            return [];
        }
    }

    function parseCSV(csvText) {
        if (!csvText) return [];
        const lines = csvText.split(/[\r\n]+/).filter(line => line.trim() !== '');
        if (lines.length < 1) return [];
        const headers = lines[0].split(',').map(header => header.trim());
        const data = [];
        for (let i = 1; i < lines.length; i++) {
            const values = lines[i].split(',').map(value => value.trim());
            if (values.length === headers.length) {
                const entry = {};
                headers.forEach((header, index) => { entry[header] = values[index]; });
                data.push(entry);
            } else {
                console.warn(`Skipping malformed CSV line ${i+1} in one of the sheets: expected ${headers.length} values, got ${values.length}. Line: ${lines[i]}`);
            }
        }
        return data;
    }
    
    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', async () => {
        initializeTabsAndSelectors();

        const dataFetchPromises = [
            fetchAndParseCsv(URL_AGGREGATED_SKATER_STATS, 'playerDataStatus', 'Skater Stats'),
            fetchAndParseCsv(URL_AGGREGATED_GOALIE_STATS, 'goalieDataStatus', 'Goalie Stats'),
            fetchAndParseCsv(URL_PUBLISHED_TEAM_STATS, 'teamDataStatus', 'Team Stats'),
            fetchAndParseCsv(URL_PUBLISHED_GAME_DATA, 'gameDataStatus', 'Game Data'),
            fetchAndParseCsv(URL_TWITCH_LINKS, 'twitchDataStatus', 'Twitch Links')
        ];
        
        const [
            rawSkaterStats, rawGoalieStats, rawTeamStats, rawGameData, rawTwitchData
        ] = await Promise.all(dataFetchPromises);

        rawSkaterStats.forEach(s => { if (s.Username) skaterSeasonStats[s.Username] = s; });
        rawGoalieStats.forEach(g => { if (g.Username) goalieSeasonStats[g.Username] = g; });
        rawTeamStats.forEach(t => { if (t.ID) teamSeasonStats[t.ID] = t; });
        allGamesData = rawGameData;
        if (rawTwitchData) {
            rawTwitchData.forEach(linkEntry => {
                if (linkEntry.Username && linkEntry.TwitchURL) {
                    playerTwitchLinks[linkEntry.Username.toLowerCase()] = linkEntry.TwitchURL; // Store twitch key as lowercase
                }
            });
        }

        const staticPlayerNameMap = {}; // Map lowercase static name to index
        staticPlayersData.forEach((player, index) => {
            staticPlayerNameMap[player.name.toLowerCase()] = { index: index, originalName: player.name };
        });

        // Normalize names in staticPlayersData against skater stats
        for (const sheetUsername in skaterSeasonStats) {
            const sheetUserLower = sheetUsername.toLowerCase();
            if (staticPlayerNameMap.hasOwnProperty(sheetUserLower)) {
                const staticPlayerInfo = staticPlayerNameMap[sheetUserLower];
                if (staticPlayerInfo.originalName !== sheetUsername) {
                    console.log(`Updating static name (skater) "${staticPlayerInfo.originalName}" to sheet name "${sheetUsername}"`);
                    staticPlayersData[staticPlayerInfo.index].name = sheetUsername;
                     // Update map key if name changed
                    delete staticPlayerNameMap[sheetUserLower];
                    staticPlayerNameMap[sheetUsername.toLowerCase()] = staticPlayerInfo;
                    staticPlayerInfo.originalName = sheetUsername; // Update originalName in map too
                }
            }
        }
        // Normalize names in staticPlayersData against goalie stats
        for (const sheetUsername in goalieSeasonStats) {
            const sheetUserLower = sheetUsername.toLowerCase();
            if (staticPlayerNameMap.hasOwnProperty(sheetUserLower)) {
                const staticPlayerInfo = staticPlayerNameMap[sheetUserLower];
                if (staticPlayerInfo.originalName !== sheetUsername) {
                    console.log(`Updating static name (goalie) "${staticPlayerInfo.originalName}" to sheet name "${sheetUsername}"`);
                    staticPlayersData[staticPlayerInfo.index].name = sheetUsername;
                    delete staticPlayerNameMap[sheetUserLower];
                    staticPlayerNameMap[sheetUsername.toLowerCase()] = staticPlayerInfo;
                    staticPlayerInfo.originalName = sheetUsername;
                }
            }
        }
        
        staticPlayersData = staticPlayersData.map(player => {
            const twitchLink = playerTwitchLinks[player.name.toLowerCase()]; // Lookup twitch with lowercase
            if (twitchLink) {
                return { ...player, twitch: twitchLink };
            }
            return player;
        });
        console.log("Final Static Players Data:", staticPlayersData);
        
        // Initial UI updates
        document.querySelectorAll('.team-select').forEach(select => {
            const teamCard = select.closest('.team-card');
            if (select.value && teamCard) { // If a team is pre-selected (e.g. from browser cache)
                populatePlayerDropdowns(teamCard, select.value); 
            }
            if (select.value) handleTeamSelection({ target: select }); // Trigger full update for pre-selected team
        });

        const activeMainTab = document.querySelector('.main-tab-content.active');
        if (activeMainTab) {
             updateMatchupDisplay(activeMainTab.id.replace('main-tab-', ''));
             if (activeMainTab.id.includes('quad')) {
                const activeFocusButton = activeMainTab.querySelector('.focus-game-button.active');
                if (activeFocusButton) updateQuadSubTabTitlesAndContent(activeFocusButton.dataset.gameNum);
             }
        }
        updateActiveStreams();
    });

    function initializeTabsAndSelectors() {
        // Populate team dropdowns
        const teamSelects = document.querySelectorAll('.team-select');
        teamSelects.forEach(select => {
            // Clear existing options except the first placeholder
            while (select.options.length > 1) select.remove(1);
            teamsData.forEach(team => {
                const option = document.createElement('option');
                option.value = team.id; // Numerical ID
                option.textContent = team.name;
                select.appendChild(option);
            });
            select.addEventListener('change', handleTeamSelection);
            select.addEventListener('change', () => updateMatchupDisplay(select.closest('.main-tab-content').id.replace('main-tab-', '')));
        });

        // Main tab switching
        const mainTabButtons = document.querySelectorAll('.main-tab-button');
        mainTabButtons.forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.main-tab-button.active, .main-tab-content.active').forEach(el => el.classList.remove('active'));
                button.classList.add('active');
                const activeTabContent = document.getElementById(button.dataset.target);
                activeTabContent.classList.add('active');
                updateActiveStreams();
                updateMatchupDisplay(button.dataset.target.replace('main-tab-', ''));
                if (button.dataset.target.includes('quad')) {
                    const activeFocusButton = activeTabContent.querySelector('.focus-game-button.active');
                     if (activeFocusButton) updateQuadSubTabTitlesAndContent(activeFocusButton.dataset.gameNum);
                }
            });
        });

        // Sub-tab switching
        document.querySelectorAll('.sub-tabs-nav').forEach(nav => {
            nav.addEventListener('click', (event) => {
                if (event.target.classList.contains('sub-tab-button')) {
                    const button = event.target;
                    const parentSubTabsSection = button.closest('.sub-tabs-section');
                    parentSubTabsSection.querySelectorAll('.sub-tab-button.active, .sub-tab-content.active').forEach(el => el.classList.remove('active'));
                    button.classList.add('active');
                    parentSubTabsSection.querySelector(`#${button.dataset.target}`).classList.add('active');
                }
            });
        });
        
        // Quad tab focus game buttons
        const quadFocusGameBtnsContainer = document.getElementById('quad-focus-game-btns');
        if (quadFocusGameBtnsContainer) {
            quadFocusGameBtnsContainer.addEventListener('click', (event) => {
                if (event.target.classList.contains('focus-game-button')) {
                    quadFocusGameBtnsContainer.querySelectorAll('.focus-game-button.active').forEach(btn => btn.classList.remove('active'));
                    event.target.classList.add('active');
                    updateQuadSubTabTitlesAndContent(event.target.dataset.gameNum);
                    updateMatchupDisplay('quad');
                }
            });
        }

        // Player positional selectors (for active streams & matchup)
        document.querySelectorAll('.player-select').forEach(select => {
            select.addEventListener('change', updateActiveStreams);
            select.addEventListener('change', () => {
                const mainTabContent = select.closest('.main-tab-content');
                if(mainTabContent) updateMatchupDisplay(mainTabContent.id.replace('main-tab-', ''));
            });
        });
        
        // Player filter multi-selects
        document.querySelectorAll('.player-filter-select').forEach(select => {
            select.addEventListener('change', handlePlayerFilterSelection);
        });
    }

    function handleTeamSelection(event) {
        const teamId = event.target.value; // This is now numerical ID
        const teamCardId = event.target.dataset.teamCardId;
        const teamCard = document.getElementById(teamCardId);
        const selectedTeamData = teamsData.find(t => t.id === teamId);

        const header = teamCard.querySelector('.team-card-header');
        if (selectedTeamData) {
            header.querySelector('.team-logo').src = selectedTeamData.logoUrl;
            header.querySelector('.team-name-display').textContent = selectedTeamData.name;
            header.querySelector('.owner-name').textContent = selectedTeamData.owner;
            header.querySelector('.gm-name').textContent = selectedTeamData.gm;
            header.style.borderLeft = `5px solid ${selectedTeamData.primaryColor}`;
            populatePlayerDropdowns(teamCard, teamId); // teamId is numerical
        } else {
            const defaultName = (teamCardId.includes("1") || teamCardId.includes("a") || teamCardId.match(/g\da$/)) ? "Team A / Home" : "Team B / Away";
            header.querySelector('.team-logo').src = "";
            header.querySelector('.team-name-display').textContent = defaultName;
            header.querySelector('.owner-name').textContent = "N/A";
            header.querySelector('.gm-name').textContent = "N/A";
            header.style.borderLeft = `5px solid var(--border-color)`;
            clearPlayerDropdowns(teamCard);
        }

        const mainTabContent = teamCard.closest('.main-tab-content');
        const teamRole = event.target.dataset.teamRole; 
        
        if (mainTabContent.id.includes('quad')) {
            const activeFocusButton = mainTabContent.querySelector('.focus-game-button.active');
            if (activeFocusButton) updateQuadSubTabTitlesAndContent(activeFocusButton.dataset.gameNum);
        } else {
            const tabPrefix = mainTabContent.id.split('-')[2];
            document.getElementById(`subtab-btn-${tabPrefix}-${teamRole}`).textContent = selectedTeamData ? `${selectedTeamData.name} Stats` : (teamRole === 'team1' ? '[Home] Stats' : '[Away] Stats');
            updateTeamSeasonStatsDisplay(`${tabPrefix}-${teamRole}`, teamId); // teamId is numerical
            populatePlayerFilterDropdown(`player-filter-${tabPrefix}-${teamRole}`, teamId); // teamId is numerical
            clearPlayerStatsDisplay(`player-stats-display-${tabPrefix}-${teamRole}`);
            displayRecentGames(`recent-games-${tabPrefix}-${teamRole}`, teamId); // teamId is numerical
        }
        updateActiveStreams();
    }

    function getPlayerScore(player, position) {
        let score = 0;
        if (position === 'G') {
            if (player.primaryPosition === 'G') score += 500;
            if (player.secondaryPosition === 'G') score += 400;
            if (player.goaliePreference === 'full time') score += 300;
            if (player.goaliePreference === 'part time') score += 200;
            if (player.goaliePreference === 'emergency') score += 100;
        } else {
            if (player.primaryPosition === position) score += 500;
            if (player.secondaryPosition === position) score += 400;
        }
        if (player.primaryPosition || player.secondaryPosition || (player.goaliePreference && player.goaliePreference !== 'never')) score += 50;
        if ((player.role === "Owner" || player.role === "GM") && !player.primaryPosition && !player.secondaryPosition && (!player.goaliePreference || player.goaliePreference === 'never')) {
             score -= 100; 
        }
        return score;
    }

    function populatePlayerDropdowns(teamCardElement, teamId) { // teamId is numerical
        const playersOfTeam = staticPlayersData.filter(p => p.teamId === teamId);
        const positions = ["C", "W", "D", "G"];
        positions.forEach(pos => {
            const select = teamCardElement.querySelector(`.player-select[data-position="${pos}"]`);
            const currentValue = select.value;
            select.innerHTML = '<option value="">-- Select --</option>'; 
            const sortedPlayers = [...playersOfTeam].sort((a, b) => getPlayerScore(b, pos) - getPlayerScore(a, pos));
            sortedPlayers.forEach(player => {
                const option = document.createElement('option');
                option.value = player.name; // Value is player name
                option.textContent = player.name;
                if (player.name === currentValue) option.selected = true;
                select.appendChild(option);
            });
        });
    }
    
    function clearPlayerDropdowns(teamCardElement) {
        teamCardElement.querySelectorAll('.player-select').forEach(select => {
            select.innerHTML = '<option value="">-- Select --</option>';
        });
    }
    
    function updateQuadSubTabTitlesAndContent(focusedGameNum) {
        const teamACardId = `tc-quad-g${focusedGameNum}a`;
        const teamBCardId = `tc-quad-g${focusedGameNum}b`;
        const teamASelect = document.querySelector(`.team-select[data-team-card-id="${teamACardId}"]`);
        const teamBSelect = document.querySelector(`.team-select[data-team-card-id="${teamBCardId}"]`);
        const teamAData = teamASelect ? teamsData.find(t => t.id === teamASelect.value) : null; // teamASelect.value is numerical ID
        const teamBData = teamBSelect ? teamsData.find(t => t.id === teamBSelect.value) : null;

        const teamAName = teamAData ? teamAData.name : `[G${focusedGameNum} Team A]`;
        const teamBName = teamBData ? teamBData.name : `[G${focusedGameNum} Team B]`;
        
        document.getElementById('subtab-btn-quad-teamA').textContent = `${teamAName} Stats`;
        document.getElementById('subtab-btn-quad-teamB').textContent = `${teamBName} Stats`;

        updateTeamSeasonStatsDisplay('quad-teamA', teamAData ? teamAData.id : null);
        populatePlayerFilterDropdown('player-filter-quad-teamA', teamAData ? teamAData.id : null);
        clearPlayerStatsDisplay('player-stats-display-quad-teamA');
        displayRecentGames('recent-games-quad-teamA', teamAData ? teamAData.id : null);
        
        updateTeamSeasonStatsDisplay('quad-teamB', teamBData ? teamBData.id : null);
        populatePlayerFilterDropdown('player-filter-quad-teamB', teamBData ? teamBData.id : null);
        clearPlayerStatsDisplay('player-stats-display-quad-teamB');
        displayRecentGames('recent-games-quad-teamB', teamBData ? teamBData.id : null);
    }
    
    function clearPlayerStatsDisplay(displayAreaId) {
        const el = document.getElementById(displayAreaId);
        if (el) el.innerHTML = '<p class="stats-placeholder">Select player(s) from the list above to see their stats.</p>';
    }

    function updateTeamSeasonStatsDisplay(targetSuffix, teamId) { // teamId is numerical
        const displayEl = document.getElementById(`team-season-stats-${targetSuffix}`);
        if (!displayEl) return;
        displayEl.innerHTML = '';
        if (!teamId || !teamSeasonStats[teamId]) {
            displayEl.innerHTML = '<p class="stats-placeholder">Team stats unavailable.</p>';
            return;
        }
        const stats = teamSeasonStats[teamId]; // stats are keyed by numerical teamId
        let content = `<ul>`;
        content += `<li>Record: ${stats.W || '0'}-${stats.L || '0'}-${stats.OTL || '0'} (${stats.PTS || '0'} PTS)</li>`;
        content += `<li>Goals For: ${stats.GF || '0'} (Per Game: ${stats['GF Per Game'] || '0.0'})</li>`;
        content += `<li>Goals Against: ${stats.GA || '0'} (Per Game: ${stats['GA Per Game'] || '0.0'})</li>`;
        content += `<li>PP%: ${stats['PP%'] || 'N/A'} | PK%: ${stats['PK %'] || 'N/A'}</li>`;
        content += `</ul>`;
        displayEl.innerHTML = content;
    }
    
    function populatePlayerFilterDropdown(selectElementId, teamId) { // teamId is numerical
        const selectElement = document.getElementById(selectElementId);
        selectElement.innerHTML = ''; 
        if (!teamId) return;
        const playersOfTeam = staticPlayersData.filter(p => p.teamId === teamId);
        playersOfTeam.sort((a,b) => a.name.localeCompare(b.name)).forEach(player => {
            const option = document.createElement('option');
            option.value = player.name; // Value is player name for stat lookup
            option.textContent = player.name;
            selectElement.appendChild(option);
        });
    }
    
    function getPlayerDisplayStatus(player) {
        if (!player) return "Player not found";
        if (player.role === "Owner" || player.role === "GM") return `Role: ${player.role}`;
        if (player.isECU || player.draftPick === "ECU") return "Status: ECU";
        // Using typeof player.draftPick === 'number' allows for pick 0
        if (typeof player.draftPick === 'number' && player.draftRound) return `Draft Pick: #${player.draftPick} (Round ${player.draftRound})`;
        if (typeof player.draftPick === 'number') return `Draft Pick: #${player.draftPick}`;
        return "Status: Regular Player";
    }

    function handlePlayerFilterSelection(event) {
        const selectElement = event.target;
        const displayAreaId = selectElement.id.replace('player-filter-', 'player-stats-display-');
        const displayArea = document.getElementById(displayAreaId);
        displayArea.innerHTML = ''; 

        const selectedPlayerNames = Array.from(selectElement.selectedOptions).map(opt => opt.value);

        if (selectedPlayerNames.length === 0) {
            clearPlayerStatsDisplay(displayAreaId);
            return;
        }

        selectedPlayerNames.forEach(playerName => {
            const staticInfo = staticPlayersData.find(p => p.name === playerName);
            if (!staticInfo) {
                displayArea.innerHTML += `<div><strong>${playerName}</strong><br>Static info not found.</div>`;
                return;
            }

            const isGoalie = staticInfo.primaryPosition === 'G' || staticInfo.secondaryPosition === 'G' || (staticInfo.goaliePreference && staticInfo.goaliePreference !== 'never' && staticInfo.goaliePreference !== 'no goalie');
            // Dynamic stats are keyed by Username (which is playerName here after normalization)
            const dynamicStats = isGoalie ? goalieSeasonStats[playerName] : skaterSeasonStats[playerName];

            const playerDiv = document.createElement('div');
            let content = `<strong>${playerName}</strong> (${staticInfo.primaryPosition || (isGoalie ? 'G' : 'N/A')})<br>`;
            content += `${getPlayerDisplayStatus(staticInfo)}<br>`;
            
            if (dynamicStats) {
                if (isGoalie) {
                    content += `GP: ${formatStat(dynamicStats.GP, '0')} | W-L: ${formatStat(dynamicStats.Wins, '0')}-${formatStat(dynamicStats.Losses, '0')} | GAA: ${formatStat(dynamicStats.GAA, '0.00')}<br>`;
                    content += `Save %: ${formatStat(dynamicStats['Save %'], '.000')} | Shutouts: ${formatStat(dynamicStats.Shutouts, '0')}`;
                } else { 
                    content += `GP: ${formatStat(dynamicStats.GP, '0')} | G: ${formatStat(dynamicStats.Goals, '0')} | A: ${formatStat(dynamicStats.Assists, '0')} | P: ${formatStat(dynamicStats.Points, '0')}<br>`;
                    content += `PIMs: ${formatStat(dynamicStats.PIMs, '0')} | PlusMinus: ${dynamicStats.PlusMinus > 0 ? '+' : ''}${formatStat(dynamicStats.PlusMinus, '0')}`;
                }
            } else {
                content += `<span class="stats-placeholder">Season stats not available for ${playerName}.</span>`;
            }
            playerDiv.innerHTML = content;
            displayArea.appendChild(playerDiv);
        });
    }

    function updateMatchupDisplay(tabPrefix) {
        const teamComparisonEl = document.getElementById(`team-comparison-${tabPrefix}`);
        const playerComparisonEl = document.getElementById(`player-comparison-${tabPrefix}`);
        if (!teamComparisonEl || !playerComparisonEl) return;

        let team1Id, team2Id, team1Card, team2Card;

        if (tabPrefix === 'quad') {
            const focusedGameNum = document.querySelector('#quad-focus-game-btns .focus-game-button.active')?.dataset.gameNum;
            if (!focusedGameNum) {
                teamComparisonEl.innerHTML = '<p class="stats-placeholder">Select a focus game.</p>';
                playerComparisonEl.innerHTML = '<p class="stats-placeholder">Select a focus game and players.</p>';
                return;
            }
            team1Card = document.getElementById(`tc-quad-g${focusedGameNum}a`);
            team2Card = document.getElementById(`tc-quad-g${focusedGameNum}b`);
            team1Id = team1Card?.querySelector('.team-select').value; // Numerical ID
            team2Id = team2Card?.querySelector('.team-select').value; // Numerical ID
        } else {
            team1Card = document.getElementById(`tc-${tabPrefix}-1`);
            team2Card = document.getElementById(`tc-${tabPrefix}-2`);
            team1Id = team1Card?.querySelector('.team-select').value; // Numerical ID
            team2Id = team2Card?.querySelector('.team-select').value; // Numerical ID
        }

        if (team1Id && team2Id && team1Id !== team2Id) {
            const team1Data = teamsData.find(t => t.id === team1Id);
            const team2Data = teamsData.find(t => t.id === team2Id);
            let team1Wins = 0, team2Wins = 0;
            
            allGamesData.forEach(game => {
                const gameTeam1Id = game['Team 1 ID']; // These are numerical IDs from GameData
                const gameTeam2Id = game['Team 2 ID'];
                const result1 = game['Team 1 Result']?.toLowerCase();

                if ((gameTeam1Id === team1Id && gameTeam2Id === team2Id)) {
                    if (result1 === 'win') team1Wins++; else if (result1 === 'loss') team2Wins++;
                } else if ((gameTeam1Id === team2Id && gameTeam2Id === team1Id)) {
                    if (result1 === 'win') team2Wins++; else if (result1 === 'loss') team1Wins++;
                }
            });
            teamComparisonEl.innerHTML = `<strong>${team1Data.name} vs ${team2Data.name} (All Time):</strong> ${team1Wins} - ${team2Wins}`;
        } else {
            teamComparisonEl.innerHTML = '<p class="stats-placeholder">Select two different teams to see H2H comparison.</p>';
        }
        displaySelectedPlayerComparison(playerComparisonEl, team1Card, team2Card);
    }

    function getPlayerDataForComparison(playerName) { // playerName is from staticPlayersData
        const staticInfo = staticPlayersData.find(p => p.name === playerName);
        if (!staticInfo) return null;
        const isGoalie = staticInfo.primaryPosition === 'G' || staticInfo.secondaryPosition === 'G' || (staticInfo.goaliePreference && staticInfo.goaliePreference !== 'never' && staticInfo.goaliePreference !== 'no goalie');
        // dynamicStats are keyed by Username (which is playerName here after normalization)
        const dynamicStats = isGoalie ? goalieSeasonStats[playerName] : skaterSeasonStats[playerName];
        return { static: staticInfo, dynamic: dynamicStats, isGoalie: isGoalie };
    }
    
    function formatStat(value, defaultValue = 'N/A') {
        return (value !== undefined && value !== null && value !== '' && value.toString().toUpperCase() !== '#DIV/0!' && value.toString().toUpperCase() !== 'N/A'  && value.toString().toUpperCase() !== '#NUM!') ? value : defaultValue;
    }

    function displaySelectedPlayerComparison(containerEl, team1CardEl, team2CardEl) {
        containerEl.innerHTML = '';
        if (!team1CardEl || !team2CardEl) {
            containerEl.innerHTML = '<p class="stats-placeholder">Team cards not found.</p>'; return;
        }
        const players = { p1: {}, p2: {} };
        ['C', 'W', 'D', 'G'].forEach(pos => {
            const p1Name = team1CardEl.querySelector(`.player-select[data-position="${pos}"]`)?.value;
            const p2Name = team2CardEl.querySelector(`.player-select[data-position="${pos}"]`)?.value;
            if (p1Name) players.p1[pos] = getPlayerDataForComparison(p1Name);
            if (p2Name) players.p2[pos] = getPlayerDataForComparison(p2Name);
        });
        const p1SelectedCount = Object.values(players.p1).filter(p => p).length;
        const p2SelectedCount = Object.values(players.p2).filter(p => p).length;
        if (p1SelectedCount === 0 && p2SelectedCount === 0) {
             containerEl.innerHTML = '<p class="stats-placeholder">Select players in team cards to compare.</p>'; return;
        }
        const team1Name = team1CardEl.querySelector('.team-name-display').textContent || 'Team 1';
        const team2Name = team2CardEl.querySelector('.team-name-display').textContent || 'Team 2';
        let content = `<div class="comparison-grid">`;
        content += `<div class="player1-col player-name-header">${team1Name}</div><div></div><div class="player2-col player-name-header">${team2Name}</div>`;
        ['C', 'W', 'D', 'G'].forEach(pos => {
            const p1 = players.p1[pos];
            const p2 = players.p2[pos];
            content += `<div class="player1-col"><strong>${pos}:</strong> ${p1 ? p1.static.name : 'N/A'}</div><div class="stat-label">vs</div><div class="player2-col"><strong>${pos}:</strong> ${p2 ? p2.static.name : 'N/A'}</div>`;
            const isGoalieComparison = (p1 && p1.isGoalie) || (p2 && p2.isGoalie); // If either selected for this slot is a goalie

            const statMetrics = isGoalieComparison ? [
                { label: 'GAA', key: 'GAA'}, { label: 'Save %', key: 'Save %'},
                { label: 'Bkawy Save %', key: 'Breakaway Save %'}, { label: 'PS Save %', key: 'Penalty Shot Save %'},
                { label: 'Diving Saves', key: 'Diving Saves'}, { label: 'Shutouts', key: 'Shutouts'}
            ] : [
                { label: 'Off. Rating', key: 'Offense Rating (Avg)', placeholder: 'N/A' },
                { label: 'Def. Rating', key: 'Defense Rating (Avg)', placeholder: 'N/A' },
                { label: 'Team Rating', key: 'Teamplay Rating (Avg)', placeholder: 'N/A' },
                { label: 'G/GP', calc: (p) => p?.dynamic?.GP > 0 ? (parseFloat(p.dynamic.Goals || 0) / p.dynamic.GP).toFixed(2) : 'N/A' },
                { label: 'A/GP', calc: (p) => p?.dynamic?.GP > 0 ? (parseFloat(p.dynamic.Assists || 0) / p.dynamic.GP).toFixed(2) : 'N/A' },
                { label: 'P/GP', calc: (p) => p?.dynamic?.GP > 0 ? (parseFloat(p.dynamic.Points || 0) / p.dynamic.GP).toFixed(2) : 'N/A' },
                { label: 'Shot %', key: 'Shot %'},
                { label: 'Deflections', key: 'Deflections', placeholder: 'N/A' }, // Add this if in AggregatedSkaterStats
                { label: 'Passes/GP', calc: (p) => p?.dynamic?.GP > 0 ? (parseFloat(p.dynamic.Passes || 0) / p.dynamic.GP).toFixed(2) : 'N/A' },
                { label: 'Pass %', key: 'Pass %'},
                { label: 'Giveaways/GP', calc: (p) => p?.dynamic?.GP > 0 ? (parseFloat(p.dynamic.Giveaways || 0) / p.dynamic.GP).toFixed(2) : 'N/A' },
                { label: 'Takeaways/GP', calc: (p) => p?.dynamic?.GP > 0 ? (parseFloat(p.dynamic.Takeaways || 0) / p.dynamic.GP).toFixed(2) : 'N/A' },
                { label: 'Blocks/GP', calc: (p) => p?.dynamic?.GP > 0 ? (parseFloat(p.dynamic['Blocked Shots'] || 0) / p.dynamic.GP).toFixed(2) : 'N/A' },
                { label: 'Poss/GP (min)', key: 'Possession (Min Per Game)'},
                { label: 'FO %', key: 'Faceoff %'},
                { label: 'PIMs', key: 'PIMs'},
                { label: 'Pen. Drawn', key: 'Penalties Drawn'}
            ];
            statMetrics.forEach(metric => {
                let val1 = 'N/A', val2 = 'N/A';
                if (metric.calc) {
                    if (p1 && p1.dynamic) val1 = metric.calc(p1); else if (p1 && !p1.dynamic && !isGoalieComparison) val1 = metric.placeholder || 'N/A';
                    if (p2 && p2.dynamic) val2 = metric.calc(p2); else if (p2 && !p2.dynamic && !isGoalieComparison) val2 = metric.placeholder || 'N/A';
                } else {
                    if (p1 && p1.dynamic) val1 = formatStat(p1.dynamic[metric.key], metric.placeholder || 'N/A'); else if (p1 && !p1.dynamic && !isGoalieComparison) val1 = metric.placeholder || 'N/A';
                    if (p2 && p2.dynamic) val2 = formatStat(p2.dynamic[metric.key], metric.placeholder || 'N/A'); else if (p2 && !p2.dynamic && !isGoalieComparison) val2 = metric.placeholder || 'N/A';
                }
                // If it's a goalie comparison but this specific metric is for skaters, show N/A
                if (isGoalieComparison && !['GAA', 'Save %', 'Breakaway Save %', 'Penalty Shot Save %', 'Diving Saves', 'Shutouts'].includes(metric.label) ) {
                    val1 = p1 && p1.isGoalie ? (p1.dynamic ? formatStat(p1.dynamic[metric.key], metric.placeholder || 'N/A') : 'N/A') : 'N/A';
                    val2 = p2 && p2.isGoalie ? (p2.dynamic ? formatStat(p2.dynamic[metric.key], metric.placeholder || 'N/A') : 'N/A') : 'N/A';
                     if (p1 && p1.isGoalie && p2 && !p2.isGoalie && !metric.label.includes("Save") && metric.label !== "GAA" && metric.label !== "Shutouts" && metric.label !== "Diving Saves") { val1 = "N/A"; }
                     if (p2 && p2.isGoalie && p1 && !p1.isGoalie && !metric.label.includes("Save") && metric.label !== "GAA" && metric.label !== "Shutouts" && metric.label !== "Diving Saves") { val2 = "N/A"; }

                } else if (!isGoalieComparison && ['GAA', 'Save %', 'Breakaway Save %', 'Penalty Shot Save %', 'Diving Saves', 'Shutouts'].includes(metric.label)) {
                    val1 = 'N/A'; val2 = 'N/A';
                }


                content += `<div class="player1-col">${val1}</div> <div class="stat-label">${metric.label}</div> <div class="player2-col">${val2}</div>`;
            });
        });
        content += `</div>`;
        containerEl.innerHTML = content;
    }
    
    function displayRecentGames(targetElementId, teamId) { // teamId is numerical
    const displayEl = document.getElementById(targetElementId);
    if (!displayEl) {
        console.warn("Recent games display element not found:", targetElementId);
        return;
    }
    displayEl.innerHTML = ''; // Clear previous content

    if (!teamId || !allGamesData || allGamesData.length === 0) {
        displayEl.innerHTML = '<p class="stats-placeholder">Recent games unavailable.</p>';
        return;
    }

    const teamGames = allGamesData
        .filter(game => game['Team 1 ID'] === teamId || game['Team 2 ID'] === teamId)
        .sort((a, b) => {
            // Sort by AdjustedDateTime (which is an ISO string) in descending order
            // Ensure dates are valid before comparing
            const dateA = new Date(a.AdjustedDateTime);
            const dateB = new Date(b.AdjustedDateTime);
            if (isNaN(dateA.getTime()) && isNaN(dateB.getTime())) return 0;
            if (isNaN(dateA.getTime())) return 1; // Put invalid dates last
            if (isNaN(dateB.getTime())) return -1; // Put invalid dates last
            return dateB - dateA; // Sorts most recent first
        })
        .slice(0, 6); // Get the last 6 games

    if (teamGames.length === 0) {
        displayEl.innerHTML = '<p class="stats-placeholder">No recent games found for this team.</p>';
        return;
    }

    let content = '<ul>';
    teamGames.forEach(game => {
        const isTeam1 = game['Team 1 ID'] === teamId;
        const opponentTeamName = isTeam1 ? game['Team 2'] : game['Team 1'];
        // Find opponent's full name from teamsData if possible, otherwise use the name from GameData
        const opponentTeamInfo = teamsData.find(t => t.id === (isTeam1 ? game['Team 2 ID'] : game['Team 1 ID']));
        const displayOpponentName = opponentTeamInfo ? opponentTeamInfo.name : opponentTeamName;

        const teamScore = isTeam1 ? game['Team 1 Score'] : game['Team 2 Score'];
        const opponentScore = isTeam1 ? game['Team 2 Score'] : game['Team 1 Score'];
        
        let result = 'vs'; // Default if result not clear
        if (game['Team 1 Result'] && game['Team 2 Result']) {
             result = (isTeam1 && game['Team 1 Result'].toLowerCase() === 'win') || 
                      (!isTeam1 && game['Team 2 Result'].toLowerCase() === 'win') 
                      ? 'W' : 'L';
        }
        
        // Use the AdjustedDateTime and DayOfWeek from the processed game data
        const displayDate = game.AdjustedDateTime 
                            ? new Date(game.AdjustedDateTime).toLocaleDateString(undefined, { month: 'short', day: 'numeric' }) 
                            : "Unknown Date";
        const dayOfWeek = game.DayOfWeek || "N/A";
        const otIndicator = game.OT && game.OT.toLowerCase() === 'yes' ? ' (OT)' : '';


        content += `<li>${displayDate} (${dayOfWeek}): ${result} ${teamScore}-${opponentScore}${otIndicator} vs ${displayOpponentName}</li>`;
    });
    content += '</ul>';
    displayEl.innerHTML = content;
}

    function updateActiveStreams() {
        const streamsList = document.getElementById('activeStreamsList');
        streamsList.innerHTML = ''; 
        const activeStreams = new Set();
        const activeMainTab = document.querySelector('.main-tab-content.active');
        if (!activeMainTab) return;
        activeMainTab.querySelectorAll('.player-select').forEach(select => {
            if (select.value) { 
                const playerName = select.value;
                const playerData = staticPlayersData.find(p => p.name === playerName); 
                if (playerData && playerData.twitch && playerData.twitch !== 'null' && playerData.twitch.trim() !== '') {
                    activeStreams.add(playerData.twitch);
                }
            }
        });
        if (activeStreams.size > 0) {
            activeStreams.forEach(twitchUrl => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = twitchUrl;
                a.textContent = twitchUrl.substring(twitchUrl.lastIndexOf('/') + 1); 
                a.target = "_blank"; 
                li.appendChild(a);
                streamsList.appendChild(li);
            });
        } else {
            streamsList.innerHTML = '<li class="stats-placeholder">No players selected with Twitch streams.</li>';
        }
    }
</script>
</body>
</html>